<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japan-Reiseplaner 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255,255,255,0.03);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .title {
            font-size: 2.2rem;
            background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcb77);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            cursor: pointer;
            margin-bottom: 8px;
            display: inline-block;
        }
        
        .title:hover {
            opacity: 0.8;
        }
        
        .subtitle {
            color: #666;
            font-size: 0.85rem;
        }
        
        /* Stats */
        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.75rem;
        }
        
        /* Buttons */
        .btn-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            color: #888;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .btn-add { background: rgba(149,225,211,0.2); color: #95e1d3; }
        .btn-export { background: rgba(78,205,196,0.2); color: #4ecdc4; }
        .btn-import { background: rgba(255,217,61,0.2); color: #ffd93d; }
        .btn-reset { background: rgba(255,107,107,0.2); color: #ff6b6b; }
        .btn-save { background: #4ecdc4; color: #fff; font-weight: bold; }
        
        /* Route */
        .route-section {
            background: rgba(255,255,255,0.03);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .section-title {
            color: #ffd93d;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .section-hint {
            font-size: 0.75rem;
            color: #666;
            margin-left: 10px;
        }
        
        .route-flow {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .route-city {
            border-radius: 12px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid;
        }
        
        .route-city:hover {
            transform: scale(1.05);
        }
        
        .route-city-icon {
            font-size: 1.2rem;
        }
        
        .route-city-name {
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .route-city-count {
            background: rgba(255,255,255,0.15);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            color: #fff;
        }
        
        .route-arrow {
            color: #444;
            font-size: 1.3rem;
        }
        
        /* Days Grid */
        .days-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .day-card {
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            padding: 18px;
            border-left: 4px solid;
            transition: all 0.3s;
        }
        
        .day-card.editing {
            background: rgba(255,255,255,0.08);
        }
        
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .day-date {
            color: #888;
            font-size: 0.85rem;
        }
        
        .day-city-tag {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .day-title {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        .day-highlights {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .highlight-tag {
            font-size: 0.75rem;
            padding: 4px 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            color: #aaa;
        }
        
        .day-actions {
            display: flex;
            gap: 5px;
            border-top: 1px solid rgba(255,255,255,0.05);
            padding-top: 10px;
        }
        
        .day-actions .btn {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        
        .day-actions .btn-edit {
            flex: 1;
        }
        
        .day-actions .btn-delete {
            background: rgba(255,100,100,0.1);
            color: #ff6b6b;
        }
        
        /* Add Day Card */
        .add-day-card {
            background: rgba(255,255,255,0.02);
            border-radius: 15px;
            padding: 18px;
            border: 2px dashed rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            min-height: 200px;
            transition: all 0.3s;
        }
        
        .add-day-card:hover {
            border-color: #ff6b6b;
        }
        
        .add-day-content {
            text-align: center;
            color: #666;
        }
        
        .add-day-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
        }
        
        .form-input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: #fff;
            font-size: 0.9rem;
            width: 100%;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #ff6b6b;
        }
        
        .form-select {
            background: #1a1a2e;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: #fff;
            font-size: 0.9rem;
            width: 100%;
            cursor: pointer;
        }
        
        .form-select option {
            background: #1a1a2e;
            color: #fff;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 70px;
        }
        
        .form-actions {
            display: flex;
            gap: 8px;
        }
        
        .form-actions .btn-save {
            flex: 1;
        }
        
        /* Custom Cities */
        .custom-cities {
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            padding: 18px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .custom-cities-title {
            color: #95e1d3;
            margin-bottom: 15px;
            font-size: 1rem;
        }
        
        .custom-cities-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .custom-city-tag {
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid;
        }
        
        .custom-city-delete {
            background: none;
            border: none;
            color: #ff6b6b;
            cursor: pointer;
            padding: 2px 5px;
            font-size: 0.8rem;
        }
        
        /* Tips */
        .tips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 25px;
        }
        
        .tip-card {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .tip-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        
        .tip-title {
            font-size: 0.65rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .tip-value {
            font-size: 0.8rem;
            color: #ddd;
            margin-top: 3px;
        }
        
        /* Footer */
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #444;
            font-size: 0.75rem;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.hidden {
            display: none;
        }
        
        .modal-content {
            background: #1a1a2e;
            border-radius: 20px;
            padding: 25px;
            max-width: 450px;
            width: 90%;
            border: 1px solid rgba(255,255,255,0.1);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-title {
            margin-bottom: 20px;
            color: #95e1d3;
        }
        
        .modal-label {
            display: block;
            margin-bottom: 5px;
            color: #888;
            font-size: 0.85rem;
        }
        
        .icon-grid, .color-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .icon-btn {
            width: 40px;
            height: 40px;
            font-size: 1.3rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
        }
        
        .icon-btn.selected {
            background: rgba(149,225,211,0.3);
            border: 2px solid #95e1d3;
        }
        
        .color-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
        }
        
        .color-btn.selected {
            border: 3px solid #fff;
            box-shadow: 0 0 10px currentColor;
        }
        
        .preview-box {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        
        .preview-label {
            color: #666;
            font-size: 0.75rem;
            margin-bottom: 8px;
        }
        
        .preview-city {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border-radius: 12px;
            padding: 10px 16px;
            border: 2px solid;
        }
        
        /* Utility */
        .hidden {
            display: none !important;
        }
        
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1 class="title" id="tripTitle" onclick="editTitle()">üáØüáµ Japan-Rundreise 2025</h1>
            <div id="titleEdit" class="hidden" style="display: flex; justify-content: center; gap: 10px; align-items: center;">
                <input type="text" id="titleInput" class="form-input" style="max-width: 400px; font-size: 1.5rem; text-align: center;">
                <button class="btn btn-save" onclick="saveTitle()">‚úì</button>
            </div>
            <p class="subtitle">Klicke auf Elemente zum Bearbeiten ‚Ä¢ Daten werden automatisch gespeichert</p>
            
            <div class="stats" id="stats"></div>
            
            <div class="btn-group">
                <button class="btn btn-add" onclick="showAddCityModal()">üèôÔ∏è Stadt hinzuf√ºgen</button>
                <button class="btn btn-export" onclick="exportData()">üíæ Exportieren</button>
                <label class="btn btn-import">
                    üìÇ Importieren
                    <input type="file" accept=".json" onchange="importData(event)">
                </label>
                <button class="btn btn-reset" onclick="resetData()">üîÑ Zur√ºcksetzen</button>
            </div>
        </header>
        
        <!-- Route -->
        <div class="route-section">
            <h2 class="section-title">
                üóæ Route
                <span class="section-hint">(Klicke auf eine Stadt zum √Ñndern)</span>
            </h2>
            <div class="route-flow" id="routeFlow"></div>
        </div>
        
        <!-- Days Grid -->
        <div class="days-grid" id="daysGrid"></div>
        
        <!-- Custom Cities -->
        <div class="custom-cities hidden" id="customCitiesSection">
            <h3 class="custom-cities-title">üèôÔ∏è Eigene St√§dte</h3>
            <div class="custom-cities-list" id="customCitiesList"></div>
        </div>
        
        <!-- Tips -->
        <div class="tips-grid">
            <div class="tip-card">
                <div class="tip-icon">üöÑ</div>
                <div class="tip-title">Transport</div>
                <div class="tip-value">Japan Rail Pass</div>
            </div>
            <div class="tip-card">
                <div class="tip-icon">üõÇ</div>
                <div class="tip-title">Visum</div>
                <div class="tip-value">EU: 90 Tage frei</div>
            </div>
            <div class="tip-card">
                <div class="tip-icon">üå∏</div>
                <div class="tip-title">Wetter Mai</div>
                <div class="tip-value">Warm, leicht</div>
            </div>
            <div class="tip-card">
                <div class="tip-icon">üí¥</div>
                <div class="tip-title">W√§hrung</div>
                <div class="tip-value">Yen (¬•)</div>
            </div>
            <div class="tip-card">
                <div class="tip-icon">üîå</div>
                <div class="tip-title">Strom</div>
                <div class="tip-value">Typ A/B, 100V</div>
            </div>
            <div class="tip-card">
                <div class="tip-icon">‚úàÔ∏è</div>
                <div class="tip-title">Route</div>
                <div class="tip-value">Tokio ‚Üí Osaka</div>
            </div>
        </div>
        
        <footer>Japan-Reiseplaner ‚Ä¢ Daten werden im Browser gespeichert</footer>
    </div>
    
    <!-- Add City Modal -->
    <div class="modal hidden" id="addCityModal" onclick="closeAddCityModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 class="modal-title">üèôÔ∏è Neue Stadt hinzuf√ºgen</h3>
            
            <div class="form-group">
                <label class="modal-label">Stadtname</label>
                <input type="text" id="newCityName" class="form-input" placeholder="z.B. Fukuoka">
            </div>
            
            <div class="form-group">
                <label class="modal-label">Icon ausw√§hlen</label>
                <div class="icon-grid" id="iconGrid"></div>
            </div>
            
            <div class="form-group">
                <label class="modal-label">Farbe ausw√§hlen</label>
                <div class="color-grid" id="colorGrid"></div>
            </div>
            
            <div class="preview-box" id="cityPreview" style="display: none;">
                <div class="preview-label">Vorschau:</div>
                <div class="preview-city" id="previewCity"></div>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-save" onclick="addCustomCity()">‚ûï Hinzuf√ºgen</button>
                <button class="btn" onclick="closeAddCityModal()">Abbrechen</button>
            </div>
        </div>
    </div>
    
    <!-- Change Route City Modal -->
    <div class="modal hidden" id="changeCityModal" onclick="closeChangeCityModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 class="modal-title" id="changeCityTitle">Stadt √§ndern</h3>
            <p style="color: #888; margin-bottom: 15px; font-size: 0.9rem;" id="changeCityInfo"></p>
            
            <select class="form-select" id="newCitySelect" onchange="changeRouteCity()">
                <option value="">Stadt ausw√§hlen...</option>
            </select>
            
            <div class="form-actions" style="margin-top: 20px;">
                <button class="btn" style="width: 100%;" onclick="closeChangeCityModal()">Abbrechen</button>
            </div>
        </div>
    </div>

    <script>
        // Default cities
        const defaultCities = {
            'Tokio': { color: '#ff6b6b', icon: 'üóº' },
            'Hakone': { color: '#4ecdc4', icon: 'üóª' },
            'Kyoto': { color: '#ffd93d', icon: '‚õ©Ô∏è' },
            'Hiroshima': { color: '#f38181', icon: 'üïäÔ∏è' },
            'Osaka': { color: '#95e1d3', icon: 'üèØ' },
            'Nara': { color: '#dda0dd', icon: 'ü¶å' },
            'Kobe': { color: '#87ceeb', icon: 'üåâ' },
            'Nagoya': { color: '#f0e68c', icon: 'üèôÔ∏è' },
            'Kanazawa': { color: '#98d8c8', icon: 'üéé' },
            'Nikko': { color: '#c9b1ff', icon: 'üå≤' },
            'Kamakura': { color: '#ffb347', icon: 'üóø' },
            'Yokohama': { color: '#77dd77', icon: 'üé°' },
            'Abreise': { color: '#888888', icon: '‚úàÔ∏è' },
            'Ankunft': { color: '#888888', icon: '‚úàÔ∏è' },
        };

        const availableColors = [
            '#ff6b6b', '#4ecdc4', '#ffd93d', '#f38181', '#95e1d3',
            '#dda0dd', '#87ceeb', '#f0e68c', '#98d8c8', '#c9b1ff',
            '#ffb347', '#77dd77', '#ff9ff3', '#54a0ff', '#5f27cd',
            '#00d2d3', '#ff9f43', '#ee5a24', '#686de0', '#badc58'
        ];

        const availableIcons = [
            'üèôÔ∏è', 'üå∏', 'üéå', 'üèØ', '‚õ©Ô∏è', 'üóº', 'üóª', 'üåä', 'üöÑ', 'üéé',
            'üçú', 'üç£', 'üéã', 'üå≤', 'üèñÔ∏è', 'üåÖ', '‚õ∞Ô∏è', 'üé°', 'üóø', 'ü¶å',
            'üïäÔ∏è', 'üåâ', '‚úàÔ∏è', 'üö¢', 'üé≠', 'üé™', 'üèõÔ∏è', '‚≠ê', 'üí´', 'üåü'
        ];

        const initialDays = [
            { id: 1, date: '8. Mai', weekday: 'Do', city: 'Tokio', title: 'Ankunft', highlights: ['‚úàÔ∏è Anreise', 'Check-in', 'Spaziergang'] },
            { id: 2, date: '9. Mai', weekday: 'Fr', city: 'Tokio', title: 'Shinjuku & Shibuya', highlights: ['Meiji-Schrein', 'Harajuku', 'Omotesand≈ç', 'Shibuya Crossing'] },
            { id: 3, date: '10. Mai', weekday: 'Sa', city: 'Tokio', title: 'Asakusa & Ueno', highlights: ['Senso-ji', 'Nakamise', 'Ueno-Park', 'Akihabara'] },
            { id: 4, date: '11. Mai', weekday: 'So', city: 'Tokio', title: 'Shinjuku & Odaiba', highlights: ['Shinjuku Gyoen', 'teamLab Planets', 'Digital Art'] },
            { id: 5, date: '12. Mai', weekday: 'Mo', city: 'Tokio', title: 'Tagesausflug', highlights: ['Nikk≈ç oder Kamakura'] },
            { id: 6, date: '13. Mai', weekday: 'Di', city: 'Tokio', title: 'Freier Tag', highlights: ['Tsukiji', 'Ginza', 'Sum≈ç-Turnier'] },
            { id: 7, date: '14. Mai', weekday: 'Mi', city: 'Hakone', title: 'Hakone-Rundkurs', highlights: ['Ashi-See', 'Owakudani', 'üóª Fuji-Blick', 'Ryokan & Onsen'] },
            { id: 8, date: '15. Mai', weekday: 'Do', city: 'Kyoto', title: 'Anreise Kyoto', highlights: ['üöÑ Shinkansen', 'Gion-Viertel', 'Geisha'] },
            { id: 9, date: '16. Mai', weekday: 'Fr', city: 'Kyoto', title: 'Tempel-Tag', highlights: ['‚õ©Ô∏è Fushimi Inari', 'Kiyomizu-dera', 'Ninen-Zaka'] },
            { id: 10, date: '17. Mai', weekday: 'Sa', city: 'Kyoto', title: 'Arashiyama', highlights: ['üéã Bambuswald', 'Tenry≈´-ji', 'Kinkaku-ji', 'Ryoan-ji'] },
            { id: 11, date: '18. Mai', weekday: 'So', city: 'Hiroshima', title: 'Peace Memorial', highlights: ['üöÑ Shinkansen', 'Friedenspark', 'Genbaku Dome', 'Museum'] },
            { id: 12, date: '19. Mai', weekday: 'Mo', city: 'Hiroshima', title: 'Miyajima-Ausflug', highlights: ['üö¢ F√§hre', '‚õ©Ô∏è Itsukushima', 'Torii im Meer', 'Mt. Misen'] },
            { id: 13, date: '20. Mai', weekday: 'Di', city: 'Osaka', title: 'Ankunft Osaka', highlights: ['üöÑ Shinkansen', 'Osaka Castle', 'Umeda Sky'] },
            { id: 14, date: '21. Mai', weekday: 'Mi', city: 'Osaka', title: 'D≈çtonbori', highlights: ['üçú Street-Food', 'Shinsaibashi', 'Neonlichter'] },
            { id: 15, date: '22. Mai', weekday: 'Do', city: 'Osaka', title: 'Tagesausflug Himeji', highlights: ['üöÑ Shinkansen', 'üèØ Himeji Castle', 'UNESCO-Welterbe'] },
            { id: 16, date: '23. Mai', weekday: 'Fr', city: 'Osaka', title: 'Letzter Tag', highlights: ['Kobe/Nara optional', 'Shopping', 'Packen'] },
            { id: 17, date: '24. Mai', weekday: 'Sa', city: 'Abreise', title: 'Heimreise', highlights: ['‚úàÔ∏è Kansai Airport'] },
        ];

        // State
        let days = [];
        let tripTitle = 'Japan-Rundreise 2025';
        let customCities = {};
        let editingDayId = null;
        let selectedIcon = availableIcons[0];
        let selectedColor = availableColors[0];
        let changingCity = null;

        // Storage
        const STORAGE_KEY = 'japan-reise-v3';

        function loadData() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    days = data.days || initialDays;
                    tripTitle = data.title || 'Japan-Rundreise 2025';
                    customCities = data.customCities || {};
                } else {
                    days = JSON.parse(JSON.stringify(initialDays));
                }
            } catch (e) {
                days = JSON.parse(JSON.stringify(initialDays));
            }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({ days, title: tripTitle, customCities }));
            } catch (e) {
                console.log('Could not save');
            }
        }

        function getAllCities() {
            return { ...defaultCities, ...customCities };
        }

        function getColor(city) {
            const all = getAllCities();
            return all[city]?.color || '#888888';
        }

        function getIcon(city) {
            const all = getAllCities();
            return all[city]?.icon || 'üìç';
        }

        // Render functions
        function render() {
            renderTitle();
            renderStats();
            renderRoute();
            renderDays();
            renderCustomCities();
            saveData();
        }

        function renderTitle() {
            document.getElementById('tripTitle').textContent = 'üáØüáµ ' + tripTitle;
        }

        function renderStats() {
            const cities = [...new Set(days.filter(d => d.city !== 'Abreise' && d.city !== 'Ankunft').map(d => d.city))];
            const nights = days.length - 1;
            
            document.getElementById('stats').innerHTML = `
                <div class="stat">
                    <div class="stat-value" style="color: #ff6b6b">${days.length}</div>
                    <div class="stat-label">TAGE</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: #ffd93d">${nights}</div>
                    <div class="stat-label">N√ÑCHTE</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: #4ecdc4">${cities.length}</div>
                    <div class="stat-label">ST√ÑDTE</div>
                </div>
            `;
        }

        function renderRoute() {
            const cities = [...new Set(days.filter(d => d.city !== 'Abreise' && d.city !== 'Ankunft').map(d => d.city))];
            
            let html = '';
            cities.forEach((city, i) => {
                const color = getColor(city);
                const icon = getIcon(city);
                const count = days.filter(d => d.city === city).length;
                
                html += `
                    <div class="route-city" style="background: ${color}22; border-color: ${color}" onclick="showChangeCityModal('${city}')">
                        <span class="route-city-icon">${icon}</span>
                        <span class="route-city-name">${city}</span>
                        <span class="route-city-count">${count}</span>
                    </div>
                `;
                
                if (i < cities.length - 1) {
                    html += '<span class="route-arrow">‚Üí</span>';
                }
            });
            
            document.getElementById('routeFlow').innerHTML = html;
        }

        function renderDays() {
            let html = '';
            
            days.forEach(day => {
                const color = getColor(day.city);
                const icon = getIcon(day.city);
                const isEditing = editingDayId === day.id;
                
                if (isEditing) {
                    html += renderEditForm(day, color);
                } else {
                    html += `
                        <div class="day-card" style="border-left-color: ${color}">
                            <div class="day-header">
                                <span class="day-date">${day.weekday}, ${day.date}</span>
                                <span class="day-city-tag" style="background: ${color}33; color: ${color}">${icon} ${day.city}</span>
                            </div>
                            <div class="day-title">${day.title}</div>
                            <div class="day-highlights">
                                ${day.highlights.map(h => `<span class="highlight-tag">${h}</span>`).join('')}
                            </div>
                            <div class="day-actions">
                                <button class="btn btn-edit" onclick="editDay(${day.id})">‚úèÔ∏è Bearbeiten</button>
                                <button class="btn" onclick="moveDay(${day.id}, -1)">‚Üë</button>
                                <button class="btn" onclick="moveDay(${day.id}, 1)">‚Üì</button>
                                <button class="btn btn-delete" onclick="deleteDay(${day.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }
            });
            
            html += `
                <div class="add-day-card" onclick="addDay()">
                    <div class="add-day-content">
                        <div class="add-day-icon">‚ûï</div>
                        <div>Neuen Tag hinzuf√ºgen</div>
                    </div>
                </div>
            `;
            
            document.getElementById('daysGrid').innerHTML = html;
        }

        function renderEditForm(day, color) {
            const allCities = getAllCities();
            const cityOptions = Object.keys(allCities).map(c => 
                `<option value="${c}" ${c === day.city ? 'selected' : ''}>${getIcon(c)} ${c}</option>`
            ).join('');
            
            return `
                <div class="day-card editing" style="border-left-color: ${color}">
                    <div class="form-group">
                        <div class="form-row">
                            <input type="text" class="form-input" id="edit-date-${day.id}" value="${day.date}" placeholder="Datum">
                            <input type="text" class="form-input" id="edit-weekday-${day.id}" value="${day.weekday}" placeholder="Tag" style="width: 60px; text-align: center;">
                        </div>
                    </div>
                    <div class="form-group">
                        <select class="form-select" id="edit-city-${day.id}">${cityOptions}</select>
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-input" id="edit-title-${day.id}" value="${day.title}" placeholder="Titel">
                    </div>
                    <div class="form-group">
                        <textarea class="form-input form-textarea" id="edit-highlights-${day.id}" placeholder="Highlights (kommagetrennt)">${day.highlights.join(', ')}</textarea>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-save" onclick="saveDay(${day.id})">üíæ Speichern</button>
                        <button class="btn" onclick="cancelEdit()">‚úï</button>
                    </div>
                </div>
            `;
        }

        function renderCustomCities() {
            const keys = Object.keys(customCities);
            const section = document.getElementById('customCitiesSection');
            
            if (keys.length === 0) {
                section.classList.add('hidden');
                return;
            }
            
            section.classList.remove('hidden');
            
            let html = '';
            keys.forEach(name => {
                const data = customCities[name];
                html += `
                    <div class="custom-city-tag" style="background: ${data.color}22; border-color: ${data.color}">
                        <span>${data.icon}</span>
                        <span>${name}</span>
                        <button class="custom-city-delete" onclick="deleteCustomCity('${name}')">‚úï</button>
                    </div>
                `;
            });
            
            document.getElementById('customCitiesList').innerHTML = html;
        }

        // Actions
        function editTitle() {
            document.getElementById('tripTitle').classList.add('hidden');
            document.getElementById('titleEdit').classList.remove('hidden');
            document.getElementById('titleEdit').style.display = 'flex';
            const input = document.getElementById('titleInput');
            input.value = tripTitle;
            input.focus();
        }

        function saveTitle() {
            tripTitle = document.getElementById('titleInput').value || 'Japan-Rundreise 2025';
            document.getElementById('tripTitle').classList.remove('hidden');
            document.getElementById('titleEdit').classList.add('hidden');
            render();
        }

        function editDay(id) {
            editingDayId = id;
            render();
        }

        function cancelEdit() {
            editingDayId = null;
            render();
        }

        function saveDay(id) {
            const day = days.find(d => d.id === id);
            if (!day) return;
            
            day.date = document.getElementById(`edit-date-${id}`).value;
            day.weekday = document.getElementById(`edit-weekday-${id}`).value;
            day.city = document.getElementById(`edit-city-${id}`).value;
            day.title = document.getElementById(`edit-title-${id}`).value;
            day.highlights = document.getElementById(`edit-highlights-${id}`).value.split(',').map(h => h.trim()).filter(h => h);
            
            editingDayId = null;
            render();
        }

        function addDay() {
            const newId = Math.max(...days.map(d => d.id), 0) + 1;
            days.push({
                id: newId,
                date: 'Neuer Tag',
                weekday: '?',
                city: 'Tokio',
                title: 'Neuer Tag',
                highlights: ['Aktivit√§t hinzuf√ºgen']
            });
            editingDayId = newId;
            render();
        }

        function deleteDay(id) {
            if (confirm('Tag wirklich l√∂schen?')) {
                days = days.filter(d => d.id !== id);
                render();
            }
        }

        function moveDay(id, direction) {
            const index = days.findIndex(d => d.id === id);
            if ((direction === -1 && index === 0) || (direction === 1 && index === days.length - 1)) return;
            
            const temp = days[index];
            days[index] = days[index + direction];
            days[index + direction] = temp;
            render();
        }

        // Add City Modal
        function showAddCityModal() {
            document.getElementById('addCityModal').classList.remove('hidden');
            document.getElementById('newCityName').value = '';
            selectedIcon = availableIcons[0];
            selectedColor = availableColors[0];
            renderIconGrid();
            renderColorGrid();
            updateCityPreview();
        }

        function closeAddCityModal(e) {
            if (!e || e.target === e.currentTarget) {
                document.getElementById('addCityModal').classList.add('hidden');
            }
        }

        function renderIconGrid() {
            let html = '';
            availableIcons.forEach(icon => {
                html += `<button class="icon-btn ${icon === selectedIcon ? 'selected' : ''}" onclick="selectIcon('${icon}')">${icon}</button>`;
            });
            document.getElementById('iconGrid').innerHTML = html;
        }

        function renderColorGrid() {
            let html = '';
            availableColors.forEach(color => {
                html += `<button class="color-btn ${color === selectedColor ? 'selected' : ''}" style="background: ${color}" onclick="selectColor('${color}')"></button>`;
            });
            document.getElementById('colorGrid').innerHTML = html;
        }

        function selectIcon(icon) {
            selectedIcon = icon;
            renderIconGrid();
            updateCityPreview();
        }

        function selectColor(color) {
            selectedColor = color;
            renderColorGrid();
            updateCityPreview();
        }

        function updateCityPreview() {
            const name = document.getElementById('newCityName').value;
            const preview = document.getElementById('cityPreview');
            
            if (name) {
                preview.style.display = 'block';
                document.getElementById('previewCity').innerHTML = `
                    <span style="font-size: 1.2rem">${selectedIcon}</span>
                    <span style="font-weight: bold">${name}</span>
                `;
                document.getElementById('previewCity').style.background = selectedColor + '22';
                document.getElementById('previewCity').style.borderColor = selectedColor;
            } else {
                preview.style.display = 'none';
            }
        }

        function addCustomCity() {
            const name = document.getElementById('newCityName').value.trim();
            if (!name) return;
            
            customCities[name] = { color: selectedColor, icon: selectedIcon };
            closeAddCityModal();
            render();
        }

        function deleteCustomCity(name) {
            if (confirm(`Stadt "${name}" wirklich l√∂schen?`)) {
                delete customCities[name];
                render();
            }
        }

        // Change City Modal
        function showChangeCityModal(city) {
            changingCity = city;
            document.getElementById('changeCityModal').classList.remove('hidden');
            document.getElementById('changeCityTitle').textContent = getIcon(city) + ' ' + city + ' √§ndern';
            document.getElementById('changeCityInfo').textContent = `Alle ${days.filter(d => d.city === city).length} Tage in "${city}" werden ge√§ndert zu:`;
            
            const allCities = getAllCities();
            let options = '<option value="">Stadt ausw√§hlen...</option>';
            Object.keys(allCities).filter(c => c !== city).forEach(c => {
                options += `<option value="${c}">${getIcon(c)} ${c}</option>`;
            });
            document.getElementById('newCitySelect').innerHTML = options;
        }

        function closeChangeCityModal(e) {
            if (!e || e.target === e.currentTarget) {
                document.getElementById('changeCityModal').classList.add('hidden');
                changingCity = null;
            }
        }

        function changeRouteCity() {
            const newCity = document.getElementById('newCitySelect').value;
            if (!newCity || !changingCity) return;
            
            days.forEach(d => {
                if (d.city === changingCity) d.city = newCity;
            });
            
            closeChangeCityModal();
            render();
        }

        // Export/Import
        function exportData() {
            const dataStr = JSON.stringify({ days, title: tripTitle, customCities }, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'japan-reise-backup.json';
            a.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.days) days = data.days;
                    if (data.title) tripTitle = data.title;
                    if (data.customCities) customCities = data.customCities;
                    render();
                    alert('Import erfolgreich!');
                } catch (err) {
                    alert('Fehler beim Import');
                }
            };
            reader.readAsText(file);
        }

        function resetData() {
            if (confirm('Alle √Ñnderungen zur√ºcksetzen?')) {
                days = JSON.parse(JSON.stringify(initialDays));
                tripTitle = 'Japan-Rundreise 2025';
                customCities = {};
                render();
            }
        }

        // Event listeners
        document.getElementById('newCityName').addEventListener('input', updateCityPreview);
        document.getElementById('titleInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') saveTitle();
        });

        // Init
        loadData();
        render();
    </script>
</body>
</html>
